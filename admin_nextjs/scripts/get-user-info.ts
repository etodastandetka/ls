#!/usr/bin/env tsx
/**
 * Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ… Telegram (username, firstName, lastName)
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: tsx scripts/get-user-info.ts
 * Ğ˜Ğ»Ğ¸ Ñ ID: tsx scripts/get-user-info.ts 8010292243 8281001567 ...
 */

import { PrismaClient } from '@prisma/client'
import { readFileSync } from 'fs'
import { join } from 'path'

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸Ğ· .env Ñ„Ğ°Ğ¹Ğ»Ğ°
function loadEnvFile() {
  try {
    const envPath = join(process.cwd(), '.env')
    const envContent = readFileSync(envPath, 'utf-8')
    const lines = envContent.split('\n')
    
    for (const line of lines) {
      const trimmedLine = line.trim()
      // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸ Ğ¸ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸
      if (!trimmedLine || trimmedLine.startsWith('#')) continue
      
      const match = trimmedLine.match(/^([^=]+)=(.*)$/)
      if (match) {
        const key = match[1].trim()
        let value = match[2].trim()
        
        // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¸ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
        if ((value.startsWith('"') && value.endsWith('"')) || 
            (value.startsWith("'") && value.endsWith("'"))) {
          value = value.slice(1, -1)
        }
        
        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° ĞµÑ‰Ğµ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°
        if (!process.env[key]) {
          process.env[key] = value
        }
      }
    }
  } catch (error) {
    // Ğ•ÑĞ»Ğ¸ .env Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
    console.log('âš ï¸  .env Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ')
  }
}

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ .env Ğ¿ĞµÑ€ĞµĞ´ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹ Prisma
loadEnvFile()

const prisma = new PrismaClient()

// Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸Ğ· Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
const userIds = [
  '8010292243',
  '8281001567',
  '6878551455',
  '8203434235',
  '834708811',
  '6027007341',
  '7405516596',
  '519867558',
  '8020129297',
  '8049922593',
  '7663342245',
  '1326203470',
  '1752339046',
  '8368623425',
  '7732505304',
  '7659220565',
  '7733283242',
  '7374979792',
  '8132989828',
  '8377017254',
]

interface UserInfo {
  userId: string
  username: string | null
  firstName: string | null
  lastName: string | null
}

async function getUserInfo(userIds: string[]) {
  try {
    console.log(`ğŸ” ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ${userIds.length} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ…...\n`)
    
    const userInfos: UserInfo[] = []
    
    for (const userId of userIds) {
      try {
        const userIdBigInt = BigInt(userId)
        
        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ Ğ¸Ğ· BotUser
        const user = await prisma.botUser.findUnique({
          where: { userId: userIdBigInt },
          select: {
            userId: true,
            username: true,
            firstName: true,
            lastName: true,
          }
        })
        
        if (user) {
          userInfos.push({
            userId: userId,
            username: user.username || null,
            firstName: user.firstName || null,
            lastName: user.lastName || null,
          })
        } else {
          // Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² BotUser, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ² Request
          const latestRequest = await prisma.request.findFirst({
            where: { userId: userIdBigInt },
            orderBy: { createdAt: 'desc' },
            select: {
              username: true,
              firstName: true,
              lastName: true,
            }
          })
          
          if (latestRequest) {
            userInfos.push({
              userId: userId,
              username: latestRequest.username || null,
              firstName: latestRequest.firstName || null,
              lastName: latestRequest.lastName || null,
            })
          } else {
            // ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ½Ğ¸Ğ³Ğ´Ğµ
            userInfos.push({
              userId: userId,
              username: null,
              firstName: null,
              lastName: null,
            })
          }
        }
      } catch (error: any) {
        console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ ${userId}:`, error.message)
        userInfos.push({
          userId: userId,
          username: null,
          firstName: null,
          lastName: null,
        })
      }
    }
    
    // Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ
    console.log('\nğŸ“‹ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹:\n')
    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”')
    console.log('â”‚ ID          â”‚ Username              â”‚ First Name       â”‚ Last Name        â”‚')
    console.log('â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤')
    
    for (const info of userInfos) {
      const id = info.userId.padEnd(11)
      const username = (info.username || 'â€”').padEnd(20).substring(0, 20)
      const firstName = (info.firstName || 'â€”').padEnd(16).substring(0, 16)
      const lastName = (info.lastName || 'â€”').padEnd(16).substring(0, 16)
      
      console.log(`â”‚ ${id} â”‚ ${username} â”‚ ${firstName} â”‚ ${lastName} â”‚`)
    }
    
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜')
    
    // Ğ¢Ğ°ĞºĞ¶Ğµ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ´Ğ»Ñ ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ° ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    console.log('\nğŸ“ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:\n')
    for (let i = 0; i < userInfos.length; i++) {
      const info = userInfos[i]
      const num = (i + 1).toString().padStart(2)
      console.log(`#${num} ID ${info.userId}`)
      console.log(`   Username: ${info.username || 'â€”'}`)
      console.log(`   Ğ˜Ğ¼Ñ: ${info.firstName || 'â€”'}`)
      console.log(`   Ğ¤Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ: ${info.lastName || 'â€”'}`)
      console.log('')
    }
    
    // Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ² CSV Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ
    console.log('\nğŸ“„ CSV Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚:\n')
    console.log('ID,Username,FirstName,LastName')
    for (const info of userInfos) {
      const username = info.username || ''
      const firstName = info.firstName || ''
      const lastName = info.lastName || ''
      console.log(`${info.userId},"${username}","${firstName}","${lastName}"`)
    }
    
    console.log('\nâœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!')
    
  } catch (error: any) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°:', error.message)
    console.error(error.stack)
    process.exit(1)
  } finally {
    await prisma.$disconnect()
  }
}

// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ· ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
const args = process.argv.slice(2)

// Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ñ‹ ID Ğ² Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ…, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸Ñ…, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ· ĞºĞ¾Ğ´Ğ°
const userIdsToQuery = args.length > 0 ? args : userIds

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ Ğ²ÑĞµÑ… ID
for (const userId of userIdsToQuery) {
  if (!/^\d+$/.test(userId)) {
    console.error(`âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: ${userId}. Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ¾.`)
    process.exit(1)
  }
}

getUserInfo(userIdsToQuery)





